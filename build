#!/bin/sh

## REQUIREMENTS
## Ruby (>= 2.3)
## 3x AWS accounts
## aws-cli
## Python3, virtualenv

# Clone the actual repo and go into it
git clone git@github.com:unicorn-ca/Unicorn-Pipeline.git pipeline
cd pipeline

git submodule update --init

# create a virtualenv
python3 -m venv unicorn-venv

# activate the venv
source unicorn-venv/bin/activate

# install Herd requirements
pip install -r tools/Herd/requirements.txt

# install Ruby requirements
cd tools/cfn-checker
gem install bundler
bundle install --path ./
cd ${OLDPWD}

# to update submodules
git submodule foreach git pull origin master
cd tools/Unicorn-Wiz

# server will run wizard, then it'll generate configs and exit
if [ "$1" = "-w" ];
then	
	python3 server.py
fi

cd ${OLDPWD}
# at this point we have cfn templates in child, predeploy & stack + herd.*.yaml
# run cfn-checker on all template files
python tool/cfn-checker/cfn-checker.py -d child predeploy stack -l logs

# if cfn-checker fails, abourt
# else, run herd to deploy the script
python tools/Herd/herd/herd.py herd.deploy.yaml

# destroy the virutalenv
# rm -rf unicorn-venv

cd ..
rm -rf pipeline
